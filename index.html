<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LIC Fit Tool — R2* (Hz) → T2* (ms) → LIC (mg/g, Wood 1.5T)</title>
<style>
  :root { --b:#0f172a; --muted:#475569; --line:#e2e8f0; --card:#f8fafc; }
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    margin:24px;
    color:var(--b);
    background:#f1f5f9;
  }
  h1{font-size:1.15rem;margin:0 0 12px}
  h2{font-size:1rem;margin:0 0 10px}
  .app{
    max-width:1100px;
    margin:0 auto;
  }
  .grid{
    display:grid;
    grid-template-columns:1.1fr 1fr;
    gap:16px;
    align-items:flex-start;
  }
  .card{
    background:white;
    border:1px solid var(--line);
    border-radius:12px;
    padding:16px;
    box-shadow:0 8px 16px rgba(15,23,42,0.04);
  }
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:6px 8px;text-align:right}
  th{text-align:center;font-weight:600}
  input[type=number]{
    width:100%;
    padding:6px 8px;
    border:1px solid #cbd5e1;
    border-radius:8px;
    font-size:0.9rem;
  }
  .rowbtn{
    background:#f1f5f9;
    border:1px solid #cbd5e1;
    padding:2px 8px;
    border-radius:8px;
    cursor:pointer;
  }
  .actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:10px
  }
  button{
    border:none;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    font-weight:600;
    font-size:0.9rem;
  }
  .fit{background:#0ea5e9;color:white}
  .add{background:#10b981;color:white}
  .pdf{background:#ef4444;color:white}
  .metrics{
    display:grid;
    grid-template-columns:repeat(3,minmax(120px,1fr));
    gap:10px;
    margin-top:10px
  }
  .metric{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px;
    text-align:center
  }
  .metric .label{color:var(--muted);font-size:.85rem}
  .metric .value{font-size:1.1rem;font-weight:700}
  .rowhint{color:var(--muted);font-size:.85rem;margin-top:8px}
  .hdr{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 8px}
  .hdr input{width:220px}

  /* Category guides */
  .guides { margin-top:14px; display:grid; gap:12px }
  .guidetable { width:100%; border-collapse:collapse; font-size:0.9rem; }
  .guidetable th, .guidetable td { border:1px solid #e2e8f0; padding:6px 8px; text-align:left; }
  .guidetable th { background:#f8fafc; }
  .hit { background:#fde68a; font-weight:700; } /* highlight current bucket */

  /* Make table area scrollable if too narrow */
  .table-wrap{
    width:100%;
    overflow-x:auto;
  }

  /* Canvas */
  canvas{
    width:100%;
    max-width:100%;
    height:280px;
    border:1px solid var(--line);
    border-radius:10px;
    display:block;
  }

  @media(max-width:900px){
    body{margin:12px;}
    .grid{grid-template-columns:1fr}
    .metrics{
      grid-template-columns:repeat(2,minmax(120px,1fr));
    }
  }

  @media(max-width:640px){
    h1{font-size:1.05rem}
    h2{font-size:0.95rem}
    table{font-size:0.85rem}
    .actions{
      flex-direction:column;
    }
    .actions button{
      width:100%;
      text-align:center;
    }
    canvas{
      height:240px;
    }
  }

  /* Print handling: hide app, show print area */
  #printArea{display:none}
  @media print{
    body{margin:0}
    .app{display:none !important}
    #printArea{
      display:block !important;
      padding:16mm;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:#0f172a
    }
    #printArea h1{font-size:18px;margin:0 0 6px}
    #printArea .sub{color:#475569;margin:0 0 14px}
    #printArea .meta, #printArea .metrics{
      width:100%;
      border-collapse:collapse;
      margin-top:8px
    }
    #printArea .meta th, #printArea .meta td,
    #printArea .metrics th, #printArea .metrics td{
      border:1px solid #e2e8f0;
      padding:8px 10px;
      text-align:left
    }
    #printArea .meta th, #printArea .metrics th{background:#f8fafc}
    #printArea .imgwrap{margin:12px 0; text-align:center}
    #printArea .imgwrap img{
      max-width:100%;
      height:auto;
      border:1px solid #e2e8f0
    }
  }
</style>

<div class="app">
  <h1>LIC Fit Tool — R2* (Hz) → T2* (ms) → LIC (mg/g, Wood 1.5T)</h1>

  <div class="grid">
    <div class="card">
      <div class="hdr"></div>

      <div class="table-wrap">
        <table id="tbl">
          <thead><tr><th>TE (ms)</th><th>Signal</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="actions">
        <button class="add" id="addRow">+ Add Row</button>
        <button class="fit" id="fitBtn">Fit Now</button>
      </div>

      <div class="rowhint">
        Tip: Keep units consistent. TE is in <b>ms</b>; R2* will be in <b>Hz (1/s)</b>.
        Model: <em>S(TE) = A · exp(−R2* · TE/1000) + C</em>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="label">R2* (Hz)</div>
          <div class="value" id="r2s">—</div>
        </div>
        <div class="metric">
          <div class="label">T2* (ms)</div>
          <div class="value" id="t2s">—</div>
        </div>
        <div class="metric">
          <div class="label">LIC (mg/g)</div>
          <div class="value" id="lic">—</div>
        </div>
      </div>

      <!-- Quick R2* → LIC converter -->
      <div class="card" style="margin-top:12px;padding:12px">
        <h2 style="margin:0 0 8px">Quick R2* → LIC (Wood 1.5T)</h2>
        <div class="hdr" style="gap:8px">
          <label style="display:flex;align-items:center;gap:8px">
            <span style="white-space:nowrap">R2* (Hz)</span>
            <input id="convR2s" type="number" step="0.1" min="0" placeholder="e.g., 1200">
          </label>
        </div>
        <div class="metrics" style="grid-template-columns:repeat(2,minmax(120px,1fr))">
          <div class="metric">
            <div class="label">LIC (mg/g)</div>
            <div class="value" id="convLIC">—</div>
          </div>
          <div class="metric">
            <div class="label">T2* (ms)</div>
            <div class="value" id="convT2s">—</div>
          </div>
        </div>
        <div class="rowhint">
          Formula: <b>LIC = 0.0254 × R2* + 0.202</b> (Wood 2005, 1.5 T).
        </div>
      </div>

      <!-- Category tables -->
      <div class="guides">
        <table class="guidetable" id="liverGuide">
          <thead><tr><th colspan="2">Liver iron (LIC, mg/g dry wt)</th></tr></thead>
          <tbody>
            <tr data-min="-inf" data-max="1.8"><td>Normal</td><td>&le; 1.8</td></tr>
            <tr data-min="1.8" data-max="7"><td>Mild</td><td>1.8 – 7</td></tr>
            <tr data-min="7" data-max="15"><td>Moderate</td><td>7 – 15</td></tr>
            <tr data-min="15" data-max="inf"><td>Severe</td><td>&gt; 15</td></tr>
          </tbody>
        </table>

        <table class="guidetable" id="heartGuide">
          <thead><tr><th colspan="2">Heart (myocardial) T2* at 1.5 T (ms)</th></tr></thead>
          <tbody>
            <tr data-type="gt" data-th="20"><td>Normal</td><td>&gt; 20</td></tr>
            <tr data-range="14-20"><td>Mild</td><td>14 – 20</td></tr>
            <tr data-range="10-14"><td>Moderate</td><td>10 – 14</td></tr>
            <tr data-type="lt" data-th="10"><td>Severe</td><td>&lt; 10</td></tr>
          </tbody>
        </table>
      </div>
      <!-- end guides -->

    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Measured vs Fitted Curve</h2>
      <canvas id="plot" width="700" height="300"></canvas>
      <div style="color:#64748b;font-size:.85rem;margin-top:6px">
        Yellow line = fitted model; blue dots = measured points
      </div>
    </div>
  </div>

  <footer style="margin-top:24px;text-align:center;font-size:0.9rem;color:#475569;">
    Developed by <b>Dr. Abdulrhman Aleisa</b> —
    Contact: <a href="mailto:abaleisa@ksu.edu.sa" style="color:#0ea5e9;text-decoration:none;">abaleisa@ksu.edu.sa</a>
  </footer>
</div>

<!-- Hidden print area -->
<div id="printArea"></div>

<script>
/* ------------------- Table & Data ------------------- */
const tbody = document.querySelector('#tbl tbody');
document.getElementById('addRow').onclick = () => addRow();
document.getElementById('fitBtn').onclick = fitNow;

let fitParams = null; // remember last fit for redraw

function addRow(te=1, s=100){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="number" step="0.01" min="0" value="${te}"></td>
    <td><input type="number" step="0.01" min="0" value="${s}"></td>
    <td style="text-align:center"><button class="rowbtn" title="remove">×</button></td>`;
  tr.querySelector('.rowbtn').onclick = () => { tr.remove(); draw(fitParams); };
  tbody.appendChild(tr);
}

// Seed with example 6 echoes
[[1.0,980],[2.0,780],[3.0,620],[4.0,480],[5.0,380],[6.0,300]].forEach(([te,s])=>addRow(te,s));

function getData(){
  const TEs=[], S=[];
  [...tbody.querySelectorAll('tr')].forEach(tr=>{
    const te = parseFloat(tr.children[0].querySelector('input').value);
    const si = parseFloat(tr.children[1].querySelector('input').value);
    if (isFinite(te) && isFinite(si)) { TEs.push(te); S.push(si); }
  });
  return {TEs,S};
}

/* ------------------- Model & Error ------------------- */
function model(p, te_ms){ const [A,R2s,C] = p; return A*Math.exp(-R2s*te_ms/1000)+C; }
function sse(p, TEs, S){
  let e=0; for(let i=0;i<TEs.length;i++){ const r = S[i]-model(p, TEs[i]); e += r*r; } return e;
}

/* ------------------- Nelder–Mead Optimizer ------------------- */
function nelderMead(f, start, args, maxIter=500){
  const n = start.length;
  let simplex = [start.slice()];
  for(let i=0;i<n;i++){
    const v = start.slice();
    v[i] = v[i] ? v[i]*(1+0.05) : 0.05;
    simplex.push(v);
  }
  function sort(){ simplex.sort((a,b)=>f(a,...args)-f(b,...args)); }
  function centroid(){
    const c = new Array(n).fill(0);
    for(let i=0;i<n;i++) for(let j=0;j<n;j++) c[j]+=simplex[i][j];
    for(let j=0;j<n;j++) c[j]/=n; return c;
  }
  const alpha=1, gamma=2, rho=0.5, sigma=0.5;
  sort();
  for(let iter=0; iter<maxIter; iter++){
    sort();
    const worst = simplex[n], best = simplex[0];
    const c = centroid();
    let xr = c.map((ci,j)=>ci + alpha*(ci - worst[j])); xr = clamp(xr);
    const fr = f(xr,...args), fbest = f(best,...args), f2nd = f(simplex[n-1],...args), fworst = f(worst,...args);

    if(fr < fbest){
      let xe = c.map((ci,j)=>ci + gamma*(xr[j]-ci)); xe = clamp(xe);
      simplex[n] = f(xe,...args) < fr ? xe : xr;
    } else if(fr < f2nd){
      simplex[n] = xr;
    } else {
      let xc;
      if(fr < fworst){ xc = c.map((ci,j)=>ci + rho*(xr[j]-ci)); }
      else           { xc = c.map((ci,j)=>ci + rho*(worst[j]-ci)); }
      xc = clamp(xc);
      if(f(xc,...args) < fworst) simplex[n] = xc;
      else {
        for(let i=1;i<simplex.length;i++){
          simplex[i] = simplex[i].map((vi,j)=> best[j] + sigma*(vi-best[j]));
          simplex[i] = clamp(simplex[i]);
        }
      }
    }
    if(Math.abs(f(simplex[0],...args)-f(simplex[n],...args)) < 1e-10) break;
  }
  sort(); return simplex[0];

  function clamp(p){
    const [A,R2s,C]=p;
    return [Math.max(0,A), Math.max(1e-6,R2s), Math.max(0,C)];
  }
}

/* ------------------- Fit & Metrics ------------------- */
function fitNow(){
  const {TEs,S} = getData();
  if(TEs.length<3){ alert('Enter at least 3 echoes.'); return; }

  const Smax = Math.max(...S), Smin = Math.min(...S);
  const start = [Smax-Smin, 100, Smin]; // [A, R2*, C]

  const p = nelderMead((prms,TEs,S)=>sse(prms,TEs,S), start, [TEs,S], 700);
  const [A,R2s,C] = p;

  const T2s_ms = 1000 / R2s;
  const LIC = 0.0254 * R2s + 0.202;

  document.getElementById('r2s').textContent = R2s.toFixed(1);
  document.getElementById('t2s').textContent = T2s_ms.toFixed(2);
  document.getElementById('lic').textContent = LIC.toFixed(2);

  fitParams = p;
  highlightGuides(LIC, T2s_ms);
  draw(fitParams);
}

/* ------------------- Guides highlighting ------------------- */
function highlightGuides(licVal, t2msVal){
  document.querySelectorAll('#liverGuide tr, #heartGuide tr').forEach(el => el.classList.remove('hit'));

  if (isFinite(licVal)) {
    document.querySelectorAll('#liverGuide tbody tr').forEach(tr => {
      const min = tr.getAttribute('data-min');
      const max = tr.getAttribute('data-max');
      const lo = (min === '-inf') ? -Infinity : parseFloat(min);
      const hi = (max === 'inf') ? Infinity : parseFloat(max);
      if (licVal > lo && licVal <= hi) tr.classList.add('hit');
    });
  }

  if (isFinite(t2msVal)) {
    document.querySelectorAll('#heartGuide tbody tr').forEach(tr => {
      const typ = tr.getAttribute('data-type');
      if (typ === 'gt') {
        const th = parseFloat(tr.getAttribute('data-th'));
        if (t2msVal > th) tr.classList.add('hit');
      } else if (typ === 'lt') {
        const th = parseFloat(tr.getAttribute('data-th'));
        if (t2msVal < th) tr.classList.add('hit');
      } else {
        const rg = tr.getAttribute('data-range');
        if (rg) {
          const [a,b] = rg.split('-').map(parseFloat);
          if (t2msVal >= a && t2msVal <= b) tr.classList.add('hit');
        }
      }
    });
  }
}

/* ------------------- Canvas Plot ------------------- */
const canvas = document.getElementById('plot');
const ctx = canvas.getContext('2d');

function draw(params=null){
  const {TEs,S} = getData();
  if(TEs.length===0){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    return;
  }
  const m = {l:50,r:10,t:10,b:30};
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const xmin = Math.min(...TEs, 0), xmax = Math.max(...TEs, 1);
  const ymin = 0, ymax = Math.max(...S, 1)*1.1;
  const W = canvas.width, H = canvas.height;
  const x2px = x => m.l + (x-xmin)/(xmax-xmin) * (W-m.l-m.r);
  const y2px = y => H-m.b - (y-ymin)/(ymax-ymin) * (H-m.t-m.b);

  ctx.strokeStyle="#94a3b8"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(m.l,m.t); ctx.lineTo(m.l,H-m.b); ctx.lineTo(W-m.r,H-m.b); ctx.stroke();

  ctx.fillStyle="#475569"; ctx.textAlign="center"; ctx.font="12px system-ui";
  for(let i=0;i<=5;i++){
    const x=xmin+(xmax-xmin)*i/5; const px=x2px(x);
    ctx.beginPath(); ctx.moveTo(px,H-m.b); ctx.lineTo(px,H-m.b+4); ctx.stroke();
    ctx.fillText(x.toFixed(1), px, H-m.b+16);
  }
  ctx.textAlign="right";
  for(let i=0;i<=4;i++){
    const y=ymin+(ymax-ymin)*i/4; const py=y2px(y);
    ctx.beginPath(); ctx.moveTo(m.l-4,py); ctx.lineTo(m.l,py); ctx.stroke();
    ctx.fillText(Math.round(y), m.l-6, py+4);
  }

  ctx.fillStyle="#2563eb";
  for(let i=0;i<TEs.length;i++){
    const px=x2px(TEs[i]), py=y2px(S[i]);
    ctx.beginPath(); ctx.arc(px,py,3,0,2*Math.PI); ctx.fill();
  }

  if(params){
    ctx.strokeStyle="#f59e0b"; ctx.lineWidth=2; ctx.beginPath();
    for(let i=0;i<400;i++){
      const te = xmin + (xmax-xmin)*i/399;
      const y = model(params, te);
      const px=x2px(te), py=y2px(y);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
  }
}
draw();

/* ---------- Quick Converter (R2* → LIC & T2*) ---------- */
function licFromR2s_Wood2005(r2sHz){ return 0.0254 * r2sHz + 0.202; }
function t2sFromR2s_ms(r2sHz){ return 1000 / r2sHz; }

(function initQuickConverter(){
  const r2in = document.getElementById('convR2s');
  const outLIC = document.getElementById('convLIC');
  const outT2s = document.getElementById('convT2s');
  if(!r2in) return;

  const update = () => {
    const v = parseFloat(r2in.value);
    if (!isFinite(v) || v <= 0) {
      outLIC.textContent = '—';
      outT2s.textContent = '—';
      document.querySelectorAll('#liverGuide tr, #heartGuide tr').forEach(el => el.classList.remove('hit'));
      return;
    }
    const lic = licFromR2s_Wood2005(v);
    const t2s = t2sFromR2s_ms(v);
    outLIC.textContent = lic.toFixed(2);
    outT2s.textContent = t2s.toFixed(2);
    highlightGuides(lic, t2s);
  };

  r2in.addEventListener('input', update);
})();
</script>
</html>
